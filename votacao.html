<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Vota√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      top: -10px;
      animation: fall linear infinite;
      opacity: 0.9;
      z-index: 9999;
      border-radius: 2px;
    }

    @keyframes fall {
      to {
        transform: translateY(110vh) rotate(360deg);
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-200 via-blue-100 to-indigo-200 min-h-screen flex items-center justify-center px-4">

<audio id="somVitoria" src="https://cdn.pixabay.com/audio/2022/03/15/audio_74bdb9fa7d.mp3"></audio>

<div class="w-full max-w-6xl bg-white shadow-2xl rounded-3xl overflow-hidden">

  <!-- TOPO -->
  <div class="bg-gradient-to-r from-blue-700 to-indigo-700 text-white text-center py-6 px-4">
    <h1 class="text-4xl font-extrabold">üó≥Ô∏è Vota√ß√£o do Gr√™mio Estudantil</h1>
    <p id="infoUsuario" class="mt-2 text-sm opacity-90"></p>
    <p id="infoPeriodo" class="mt-1 text-sm font-semibold"></p>
  </div>

  <div class="p-8">

    <!-- VENCEDOR -->
    <div id="areaVencedor" class="hidden mb-10 text-center bg-green-50 border border-green-300 rounded-xl p-6 shadow-inner">
      <h2 class="text-3xl font-extrabold text-green-700 mb-2">üèÜ CHAPA VENCEDORA</h2>
      <p id="nomeVencedor" class="text-2xl font-bold text-green-900"></p>
    </div>

    <!-- STATUS -->
    <div id="statusVoto" class="text-center text-lg font-bold mb-8"></div>

    <!-- LISTA DE CHAPAS -->
    <div id="listaChapas" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8 mb-12"></div>

    <!-- PAINEL DO GESTOR -->
    <div id="areaGestor" class="hidden border-t pt-10 mt-10">

      <h2 class="text-3xl font-extrabold text-slate-800 mb-6 text-center">
        ‚öôÔ∏è Painel do Gestor
      </h2>

      <!-- CONFIGURA√á√ÉO -->
      <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6 shadow-md mb-6">
        <h3 class="text-lg font-bold text-blue-800 mb-4">Per√≠odo da Vota√ß√£o</h3>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-600 mb-1">In√≠cio</label>
            <input type="datetime-local" id="dataInicio"
              class="w-full border rounded-lg p-2">
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-600 mb-1">Fim</label>
            <input type="datetime-local" id="dataFim"
              class="w-full border rounded-lg p-2">
          </div>
        </div>

        <button onclick="salvarPeriodoVotacao()"
          class="mt-5 bg-green-600 text-white py-3 rounded-xl w-full font-extrabold">
          üíæ Salvar Per√≠odo
        </button>
      </div>

      <!-- RESET -->
      <button onclick="reiniciarVotacao()"
        class="w-full bg-red-600 text-white py-4 rounded-xl font-extrabold shadow-lg">
        üîÑ Reiniciar Vota√ß√£o
      </button>

      <!-- RESULTADOS -->
      <div id="areaResultadosFinais" class="hidden mt-10">
        <h2 class="text-2xl font-bold mb-4 text-slate-800">üìä Resultados Finais</h2>
        <div id="resultado" class="space-y-3"></div>
      </div>

    </div>
  </div>
</div>

<script>
/* =======================
   CONTROLE DE LOGIN
======================= */
const role = localStorage.getItem("role");
const nomeUsuario = localStorage.getItem("nomeUsuario");

if (!role || !nomeUsuario) {
  alert("Voc√™ precisa estar logado!");
  location.href = "login.html";
}

infoUsuario.textContent = `Usu√°rio: ${nomeUsuario} | Tipo: ${role}`;

/* =======================
   PER√çODO DA VOTA√á√ÉO
======================= */
const dataInicioStorage = localStorage.getItem("votacao_inicio");
const dataFimStorage = localStorage.getItem("votacao_fim");

const DATA_INICIO = dataInicioStorage ? new Date(dataInicioStorage) : null;
const DATA_FIM = dataFimStorage ? new Date(dataFimStorage) : null;

if (DATA_INICIO && DATA_FIM) {
  infoPeriodo.textContent = `Per√≠odo: ${DATA_INICIO.toLocaleString()} at√© ${DATA_FIM.toLocaleString()}`;
} else {
  infoPeriodo.textContent = "‚ö†Ô∏è Per√≠odo ainda n√£o definido pelo gestor.";
}

const agora = new Date();
const votacaoAtiva = DATA_INICIO && DATA_FIM && agora >= DATA_INICIO && agora <= DATA_FIM;
const votacaoEncerrada = DATA_FIM && agora > DATA_FIM;

/* =======================
   CHAPAS E VOTOS
======================= */
const chapas = JSON.parse(localStorage.getItem("chapas") || "[]");
let votos = JSON.parse(localStorage.getItem("votos") || "{}");

const chaveVotoUsuario = "jaVotou_" + nomeUsuario;

/* =======================
   GESTOR
======================= */
if (role === "gestor") areaGestor.classList.remove("hidden");

function salvarPeriodoVotacao() {
  const inicio = new Date(dataInicio.value);
  const fim = new Date(dataFim.value);

  if (inicio >= fim) return alert("Datas inv√°lidas!");

  localStorage.setItem("votacao_inicio", inicio.toISOString());
  localStorage.setItem("votacao_fim", fim.toISOString());

  alert("‚úÖ Per√≠odo salvo!");
  location.reload();
}

/* =======================
   RENDER CHAPAS
======================= */
function renderChapas() {
  listaChapas.innerHTML = "";

  if (votacaoEncerrada) {
    mostrarVencedor();
    return;
  }

  chapas.forEach((c, i) => {
    const card = document.createElement("div");
    card.className = "bg-slate-50 border p-6 rounded-2xl shadow-md flex flex-col";

    card.innerHTML = `
      <h3 class="font-extrabold text-lg mb-2">${c.nome}</h3>
      <p class="text-sm text-slate-600 flex-1">${c.proposta}</p>
      ${role === "aluno" && votacaoAtiva ? `
        <button onclick="votar(${i})"
          class="mt-4 bg-blue-600 text-white py-2 rounded-xl font-bold">
          ‚úÖ Votar
        </button>` : ""}
    `;

    listaChapas.appendChild(card);
  });
}

/* =======================
   VOTAR
======================= */
function votar(i) {
  if (localStorage.getItem(chaveVotoUsuario)) {
    alert("Voc√™ j√° votou!");
    return;
  }

  votos[i] = (votos[i] || 0) + 1;
  localStorage.setItem("votos", JSON.stringify(votos));
  localStorage.setItem(chaveVotoUsuario, true);

  atualizarStatus();
  alert("‚úÖ Voto registrado!");
}

/* =======================
   STATUS
======================= */
function atualizarStatus() {
  if (role === "aluno") {
    if (localStorage.getItem(chaveVotoUsuario)) {
      statusVoto.textContent = "‚úÖ Voc√™ j√° votou.";
    } else if (votacaoAtiva) {
      statusVoto.textContent = "üü¢ Vota√ß√£o aberta.";
    } else {
      statusVoto.textContent = "üî¥ Vota√ß√£o encerrada.";
    }
  }
}

/* =======================
   RESULTADO FINAL
======================= */
function renderResultado() {
  resultado.innerHTML = "";
  chapas.forEach((c, i) => {
    resultado.innerHTML += `
      <div class="flex justify-between bg-slate-200 p-3 rounded-lg font-semibold">
        <span>${c.nome}</span>
        <span>${votos[i] || 0} votos</span>
      </div>
    `;
  });
}

/* =======================
   REINICIAR
======================= */
function reiniciarVotacao() {
  if (!confirm("Deseja apagar todos os votos?")) return;

  localStorage.removeItem("votos");

  Object.keys(localStorage).forEach(k => {
    if (k.startsWith("jaVotou_")) localStorage.removeItem(k);
  });

  alert("‚úÖ Vota√ß√£o reiniciada!");
  location.reload();
}

/* =======================
   VENCEDOR + CONFETE
======================= */
function mostrarVencedor() {
  let maior = -1;
  let index = null;

  Object.keys(votos).forEach(i => {
    const total = Number(votos[i]);
    if (total > maior) {
      maior = total;
      index = Number(i);
    }
  });

  if (index === null || !chapas[index]) return;

  // ‚úÖ MOSTRA A CHAPA VENCEDORA PARA ALUNO E GESTOR
  areaVencedor.classList.remove("hidden");
  nomeVencedor.textContent = chapas[index].nome;

  // ‚úÖ CONFETES + SOM SOMENTE PARA O ALUNO
  if (role === "aluno") {
    iniciarConfeteContinuo();

    const audio = document.getElementById("somVitoria");
    if (audio) {
      audio.currentTime = 0;
      audio.play().catch(()=>{});
    }
  }

  // ‚úÖ RESULTADOS APENAS PARA O GESTOR
  if (role === "gestor") {
    areaResultadosFinais.classList.remove("hidden");
    renderResultado();
  }
}

/* =======================
   CONFETE
======================= */
function iniciarConfeteContinuo() {
  setInterval(() => {
    const c = document.createElement("div");
    c.className = "confetti";
    c.style.left = Math.random() * 100 + "vw";
    c.style.backgroundColor = `hsl(${Math.random() * 360},100%,50%)`;
    c.style.animationDuration = Math.random() * 3 + 2 + "s";
    document.body.appendChild(c);

    setTimeout(() => c.remove(), 5000);
  }, 120);
}

/* =======================
   INICIALIZA√á√ÉO
======================= */
if (DATA_INICIO && DATA_FIM) {
  dataInicio.value = DATA_INICIO.toISOString().slice(0, 16);
  dataFim.value = DATA_FIM.toISOString().slice(0, 16);
}

renderChapas();
atualizarStatus();

if (votacaoEncerrada) {
  mostrarVencedor();
}
</script>

</body>
</html>
